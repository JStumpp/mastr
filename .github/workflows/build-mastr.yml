name: build-mastr
on:
  workflow_dispatch:
  schedule:
      # Trigger Mondays at 07:04 UTC.
    - cron: '7 4 * * MON'
jobs:
  build-mastr:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Set up Go
        uses: actions/setup-go@v2
      - name: Install pup
        run: |
          wget --output-document pup.zip --no-verbose https://github.com/ericchiang/pup/releases/download/v0.4.0/pup_v0.4.0_linux_amd64.zip
          unzip pup.zip
          chmod +x pup
          sudo mv pup /usr/bin/pup
          rm pup.zip
      - name: Install yj
        run: |
          sudo wget --output-document /usr/bin/yj --no-verbose https://github.com/sclevine/yj/releases/download/v5.0.0/yj-linux
          sudo chmod +x /usr/bin/yj
      - name: Install packages
        run: >
          DEBIAN_FRONTEND=noninteractive
          sudo apt-get install -y --no-install-recommends
          axel
          brotli
          libxml2-utils
          osmium-tool
          pv
          ruby-mustache
          spatialite-bin
          sqlite3
      - name: Download raw data
        run: make -C mastr download
      - name: Build database
        run: make -j2 -C mastr Marktstammdatenregister.db.br
